<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Kayıt Ol</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f4f7f6;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 500px;
            margin: 40px auto;
            background: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        h2, h3 {
            text-align: center;
            margin-top: 0;
            color: #333;
        }
        label {
            display: block;
            margin-top: 12px;
            font-weight: 600;
            color: #555;
        }
        input, textarea {
            width: 100%;
            padding: 9px;
            margin-top: 5px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-family: inherit;
        }
        textarea { resize: vertical; min-height: 70px; }
        .btn-primary, .btn-secondary {
            width: 100%;
            margin-top: 18px;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
        }
        .btn-primary { background: #28a745; color: #fff; }
        .btn-primary:hover { background: #218838; }
        .btn-secondary { background: #6c757d; color: #fff; }
        .btn-secondary:hover { background: #5a6268; }
        .message {
            margin-top: 15px;
            text-align: center;
            font-size: 14px;
        }
        .message.error { color: #e74c3c; }
        .message.success { color: #27ae60; }
        .step {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .radio-row {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
        }
        .radio-row label {
            font-weight: normal;
        }
        .link-row {
            margin-top: 15px;
            text-align: center;
            font-size: 14px;
        }
        .link-row a {
            color: #007bff;
            text-decoration: none;
        }
        .link-row a:hover {
            text-decoration: underline;
        }
        #company-section { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2>Kayıt Ol</h2>

    <!-- ADIM 1: Kullanıcı kaydı -->
    <form id="register-form">
        <label for="reg-email">E-posta</label>
        <input type="email" id="reg-email" required placeholder="ornek@mail.com">

        <label for="reg-password">Şifre</label>
        <input type="password" id="reg-password" required placeholder="En az 6 karakter">

        <label for="reg-password2">Şifre (Tekrar)</label>
        <input type="password" id="reg-password2" required placeholder="Şifrenizi tekrar girin">

        <button class="btn-primary" type="submit">Kayıt Ol</button>
    </form>

    <div id="msg-step1" class="message"></div>

    <!-- ADIM 2: Hesap tipi seçimi -->
    <div id="step2" class="step" style="display:none;">
        <h3>Hesap Tipi Seç</h3>
        <p style="text-align:center;">Bu mail ile bireysel kullanıcı mı yoksa şirket hesabı mı açmak istiyorsun?</p>

        <div class="radio-row">
            <label><input type="radio" name="role" value="user" checked> Bireysel Kullanıcı</label>
            <label><input type="radio" name="role" value="company"> Şirket Hesabı</label>
        </div>

        <button class="btn-secondary" id="btn-continue">Devam Et</button>

        <!-- Şirket formu -->
        <div id="company-section">
            <h3>Şirket Bilgileri</h3>

            <label for="c-tursab">TÜRSAB No</label>
            <input type="text" id="c-tursab" placeholder="Örn: A1234" required>

            <label for="c-name">Şirket Adı</label>
            <input type="text" id="c-name" placeholder="Örn: BlueSky Tours" required>

            <label for="c-email">Şirket E-posta</label>
            <input type="email" id="c-email" placeholder="sirket@mail.com" required>

            <label for="c-phone">Telefon</label>
            <input type="text" id="c-phone" placeholder="+90555..." required>

            <label for="c-address">Adres</label>
            <textarea id="c-address" placeholder="Şirket adresi"></textarea>

            <button class="btn-primary" id="btn-company-save">Şirket Olarak Kaydet</button>
            <div id="msg-company" class="message"></div>
        </div>
    </div>

    <div class="link-row">
        Zaten hesabın var mı? <a href="login.html">Giriş yap</a>
    </div>
</div>

<script>
    const API_BASE = "http://localhost:8080/api";

    let createdUserId = null;

    // 1. ADIM: Kullanıcı kaydı
    document.getElementById("register-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const msg = document.getElementById("msg-step1");
        msg.textContent = "";
        msg.className = "message";

        const email = document.getElementById("reg-email").value.trim();
        const password = document.getElementById("reg-password").value.trim();
        const password2 = document.getElementById("reg-password2").value.trim();

        if (!email || !password || !password2) {
            msg.textContent = "Lütfen tüm alanları doldurun.";
            msg.classList.add("error");
            return;
        }
        if (password !== password2) {
            msg.textContent = "Şifreler uyuşmuyor.";
            msg.classList.add("error");
            return;
        }

        try {
            const res = await fetch(`${API_BASE}/auth/register`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email, password })
            });

            const text = await res.text();

            if (!res.ok) {
                msg.textContent = text || "Kayıt başarısız.";
                msg.classList.add("error");
                return;
            }

            const data = JSON.parse(text); // {id, email}
            createdUserId = data.id;
            localStorage.setItem("userId", data.id);
            localStorage.setItem("userEmail", data.email);
            localStorage.setItem("isLoggedIn", "true");

            msg.textContent = "Kullanıcı kaydı başarılı! Şimdi hesap tipini seç.";
            msg.classList.add("success");

            // Şirket e-posta kutusunu otomatik doldur
            document.getElementById("c-email").value = email;

            // Adım 2'yi göster
            document.getElementById("step2").style.display = "block";

        } catch (err) {
            console.error(err);
            msg.textContent = "Sunucu hatası veya backend kapalı olabilir.";
            msg.classList.add("error");
        }
    });

    // "Devam Et" butonu: rol seçimine göre hareket
    document.getElementById("btn-continue").addEventListener("click", () => {
        const role = document.querySelector('input[name="role"]:checked').value;

        if (role === "user") {
            // Bireysel kullanıcı: direkt ana sayfaya
            alert("Kayıt tamamlandı! Bireysel kullanıcı olarak devam ediyorsun.");
            window.location.href = "index.html";
        } else {
            // Şirket seçildiyse şirket formunu aç
            document.getElementById("company-section").style.display = "block";
        }
    });

    // Şirket kaydı
    document.getElementById("btn-company-save").addEventListener("click", async () => {
        const msg = document.getElementById("msg-company");
        msg.textContent = "";
        msg.className = "message";

        if (!createdUserId) {
            msg.textContent = "Önce kullanıcı kaydının tamamlanması gerekiyor.";
            msg.classList.add("error");
            return;
        }

        const tursabNo = document.getElementById("c-tursab").value.trim();
        const name = document.getElementById("c-name").value.trim();
        const email = document.getElementById("c-email").value.trim();
        const phoneNo = document.getElementById("c-phone").value.trim();
        const address = document.getElementById("c-address").value.trim();

        if (!tursabNo || !name || !email) {
            msg.textContent = "TÜRSAB No, Şirket adı ve E-posta zorunludur.";
            msg.classList.add("error");
            return;
        }

        const body = {
            userId: createdUserId,
            tursabNo,
            name,
            email,
            phoneNo,
            address
        };

        try {
            const res = await fetch(`${API_BASE}/company/register`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body)
            });

            const text = await res.text();

            if (!res.ok) {
                msg.textContent = text || "Şirket kaydı başarısız.";
                msg.classList.add("error");
                return;
            }

            const data = JSON.parse(text); // {id, userId, ...}
            localStorage.setItem("companyId", data.id);
            localStorage.setItem("isCompany", "true");

            msg.textContent = "Şirket kaydı başarılı! Şirket paneline yönlendiriliyorsun.";
            msg.classList.add("success");

            setTimeout(() => {
                window.location.href = "company.html";   // yeni yapacağımız sayfa
            }, 1200);

        } catch (err) {
            console.error(err);
            msg.textContent = "Sunucu hatası veya backend kapalı olabilir.";
            msg.classList.add("error");
        }
    });
</script>

</body>
</html>
