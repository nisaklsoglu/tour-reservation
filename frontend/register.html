<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <title>KayÄ±t Ol</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f4f7f6;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 500px;
            margin: 40px auto;
            background: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        h2, h3 {
            text-align: center;
            margin-top: 0;
            color: #333;
        }
        label {
            display: block;
            margin-top: 12px;
            font-weight: 600;
            color: #555;
        }
        input, textarea {
            width: 100%;
            padding: 9px;
            margin-top: 5px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-family: inherit;
        }
        textarea { 
            resize: vertical; 
            min-height: 70px; 
        }
        .btn-primary {
            width: 100%;
            margin-top: 18px;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            background: #28a745; 
            color: #fff; 
        }
        .btn-primary:hover { 
            background: #218838; 
        }
        .message {
            margin-top: 15px;
            text-align: center;
            font-size: 14px;
        }
        .message.error { 
            color: #e74c3c; 
        }
        .message.success { 
            color: #27ae60; 
        }
        .step {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .radio-row {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
        }
        .radio-row label {
            font-weight: normal;
        }
        .link-row {
            margin-top: 15px;
            text-align: center;
            font-size: 14px;
        }
        .link-row a {
            color: #007bff;
            text-decoration: none;
        }
        .link-row a:hover {
            text-decoration: underline;
        }

       
        .input-error {
            border: 2px solid #e74c3c !important;
            background: #fdecea;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>KayÄ±t Ol</h2>


    <form id="register-form" novalidate>
        <!-- KULLANICI BÄ°LGÄ°LERÄ° -->
        <label for="reg-email">E-posta</label>
        <input type="text" id="reg-email" placeholder="ornek@mail.com">

        <label for="reg-password">Åžifre</label>
        <input type="password" id="reg-password" placeholder="En az 6 karakter">

        <label for="reg-password2">Åžifre (Tekrar)</label>
        <input type="password" id="reg-password2" placeholder="Åžifrenizi tekrar girin">

        <!-- HESAP TÄ°PÄ° SEÃ‡Ä°MÄ° -->
        <div class="step">
            <h3>Hesap Tipi</h3>
            <p style="text-align:center;">Bu mail ile bireysel kullanÄ±cÄ± mÄ± yoksa ÅŸirket hesabÄ± mÄ± aÃ§mak istiyorsun?</p>
            <div class="radio-row">
                <label><input type="radio" name="role" value="user" checked> Bireysel KullanÄ±cÄ±</label>
                <label><input type="radio" name="role" value="company"> Åžirket HesabÄ±</label>
            </div>
        </div>

        <!-- ÅžÄ°RKET FORMU  -->
        <div id="company-section" style="display:none;">
            <h3>Åžirket Bilgileri</h3>

            <label for="c-tursab">TÃœRSAB No</label>
            <!-- tam 5 rakam, sadece rakam -->
            <input type="text" id="c-tursab" placeholder="Ã–rn: 12345" maxlength="5">

            <label for="c-name">Åžirket AdÄ±</label>
            <!-- max 50 karakter -->
            <input type="text" id="c-name" placeholder="Ã–rn: BlueSky Tours" maxlength="50">

            <label for="c-email">Åžirket E-posta</label>
            <input type="text" id="c-email" placeholder="sirket@mail.com">

            <label for="c-phone">Telefon</label>
            <!-- max 16 karakter ( + iÅŸareti + 15 rakam ) -->
            <input type="text" id="c-phone" placeholder="+90555..." maxlength="16">

            <label for="c-address">Adres</label>
            <!-- max 250 karakter -->
            <textarea id="c-address" placeholder="Åžirket adresi" maxlength="250"></textarea>
        </div>

        <!-- TEK BUTON -->
        <button class="btn-primary" type="submit">KayÄ±t Ol</button>
    </form>

    <div id="msg-step1" class="message"></div>

    <div class="link-row">
        Zaten hesabÄ±n var mÄ±? <a href="login.html">GiriÅŸ yap</a>
    </div>
</div>

<script>
    const API_BASE = "http://localhost:8080/api";

    let createdUserId = null;

    // Regex'ler
    const emailRegex  = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;   // basit e-posta kontrolÃ¼
    const phoneRegex  = /^\+?\d{10,15}$/;               // +90555... / 0555...
    const tursabRegex = /^\d{5}$/;                      // tam 5 rakam

    const companySection = document.getElementById("company-section");
    const msgBox = document.getElementById("msg-step1");

    // ðŸ”§ Error helper'larÄ±
    function markError(input) {
        if (input) input.classList.add("input-error");
    }

    function clearErrors() {
        document.querySelectorAll(".input-error").forEach(el => {
            el.classList.remove("input-error");
        });
    }

    // Hesap tipi deÄŸiÅŸince ÅŸirket bÃ¶lÃ¼mÃ¼nÃ¼ gÃ¶ster/gizle
    document.querySelectorAll('input[name="role"]').forEach(radio => {
        radio.addEventListener("change", () => {
            const role = document.querySelector('input[name="role"]:checked').value;
            if (role === "company") {
                companySection.style.display = "block";

                // KullanÄ±cÄ± e-mail'i yazÄ±lmÄ±ÅŸsa ÅŸirket mailine kopyala (boÅŸsa)
                const mainEmail = document.getElementById("reg-email").value.trim();
                const cEmailInput = document.getElementById("c-email");
                if (mainEmail && !cEmailInput.value) {
                    cEmailInput.value = mainEmail;
                }
            } else {
                companySection.style.display = "none";
            }
        });
    });

    // TÃœRSAB alanÄ±na sadece rakam yazÄ±lsÄ±n
    document.getElementById("c-tursab").addEventListener("input", (e) => {
        e.target.value = e.target.value.replace(/\D/g, '').slice(0, 5);
    });

    // FORM SUBMIT
    document.getElementById("register-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        clearErrors();
        msgBox.textContent = "";
        msgBox.className = "message";

        const email     = document.getElementById("reg-email").value.trim();
        const password  = document.getElementById("reg-password").value.trim();
        const password2 = document.getElementById("reg-password2").value.trim();
        const role      = document.querySelector('input[name="role"]:checked').value;

        const emailInput = document.getElementById("reg-email");
        const passInput  = document.getElementById("reg-password");
        const pass2Input = document.getElementById("reg-password2");

        // --- KullanÄ±cÄ± alanlarÄ± validation ---
        if (!email || !password || !password2) {
            msgBox.textContent = "LÃ¼tfen tÃ¼m kullanÄ±cÄ± alanlarÄ±nÄ± doldurun.";
            msgBox.classList.add("error");
            if (!email)    markError(emailInput);
            if (!password) markError(passInput);
            if (!password2)markError(pass2Input);
            return;
        }

        if (!emailRegex.test(email)) {
            msgBox.textContent = "LÃ¼tfen geÃ§erli bir e-posta adresi girin.";
            msgBox.classList.add("error");
            markError(emailInput);
            return;
        }

        if (password.length < 6) {
            msgBox.textContent = "Åžifre en az 6 karakter olmalÄ±.";
            msgBox.classList.add("error");
            markError(passInput);
            return;
        }

        if (password !== password2) {
            msgBox.textContent = "Åžifreler uyuÅŸmuyor.";
            msgBox.classList.add("error");
            markError(passInput);
            markError(pass2Input);
            return;
        }

        // --- Åžirket hesabÄ± ise company alanlarÄ±nÄ± da kontrol et ---
        let companyBody = null;

        if (role === "company") {
            const tursabNo = document.getElementById("c-tursab").value.trim();
            const cName    = document.getElementById("c-name").value.trim();
            const cEmail   = document.getElementById("c-email").value.trim();
            const cPhone   = document.getElementById("c-phone").value.trim();
            const cAddr    = document.getElementById("c-address").value.trim();

            const tursabInput = document.getElementById("c-tursab");
            const cNameInput  = document.getElementById("c-name");
            const cEmailInput = document.getElementById("c-email");
            const cPhoneInput = document.getElementById("c-phone");
            const cAddrInput  = document.getElementById("c-address");

            // Zorunlu alanlar
            if (!tursabNo || !cName || !cEmail || !cPhone) {
                msgBox.textContent = "TÃœRSAB No, Åžirket adÄ±, Åžirket e-posta ve Telefon zorunludur.";
                msgBox.classList.add("error");
                if (!tursabNo) markError(tursabInput);
                if (!cName)    markError(cNameInput);
                if (!cEmail)   markError(cEmailInput);
                if (!cPhone)   markError(cPhoneInput);
                return;
            }

            // TÃœRSAB: tam 5 rakam
            if (!tursabRegex.test(tursabNo)) {
                msgBox.textContent = "TÃœRSAB No tam 5 haneli ve sadece rakamlardan oluÅŸmalÄ±dÄ±r.";
                msgBox.classList.add("error");
                markError(tursabInput);
                return;
            }

            // Åžirket adÄ±: max 50 karakter
            if (cName.length > 50) {
                msgBox.textContent = "Åžirket adÄ± en fazla 50 karakter olabilir.";
                msgBox.classList.add("error");
                markError(cNameInput);
                return;
            }

            // Åžirket e-posta
            if (!emailRegex.test(cEmail)) {
                msgBox.textContent = "LÃ¼tfen geÃ§erli bir ÅŸirket e-posta adresi girin.";
                msgBox.classList.add("error");
                markError(cEmailInput);
                return;
            }

            // Telefon
            if (!phoneRegex.test(cPhone)) {
                msgBox.textContent = "LÃ¼tfen geÃ§erli bir telefon numarasÄ± girin. (Ã–rn: +905551112233)";
                msgBox.classList.add("error");
                markError(cPhoneInput);
                return;
            }

            // Adres: max 250 karakter
            if (cAddr.length > 250) {
                msgBox.textContent = "Adres en fazla 250 karakter olabilir.";
                msgBox.classList.add("error");
                markError(cAddrInput);
                return;
            }

            companyBody = {
                tursabNo,
                name: cName,
                email: cEmail,
                phoneNo: cPhone,
                address: cAddr
            };
        }

        // --- 1. istek: KullanÄ±cÄ± kaydÄ± ---
        try {
            const res = await fetch(`${API_BASE}/auth/register`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email, password })
            });

            const text = await res.text();

            if (!res.ok) {
                msgBox.textContent = text || "KayÄ±t baÅŸarÄ±sÄ±z.";
                msgBox.classList.add("error");
                return;
            }

            const data = JSON.parse(text); // {id, email}
            createdUserId = data.id;
            localStorage.setItem("userId", data.id);
            localStorage.setItem("userEmail", data.email);
            localStorage.setItem("isLoggedIn", "true");

            // Bireysel kullanÄ±cÄ± ise burada bitiyor
            if (role === "user") {
                msgBox.textContent = "KayÄ±t baÅŸarÄ±lÄ±! Bireysel kullanÄ±cÄ± olarak devam ediyorsun.";
                msgBox.classList.add("success");

                setTimeout(() => {
                    window.location.href = "index.html";
                }, 1000);
                return;
            }

            // --- 2. istek: Åžirket kaydÄ± ---
            companyBody.userId = createdUserId;

            const resComp = await fetch(`${API_BASE}/company/register`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(companyBody)
            });

            const textComp = await resComp.text();

            if (!resComp.ok) {
                msgBox.textContent = textComp || "Åžirket kaydÄ± baÅŸarÄ±sÄ±z.";
                msgBox.classList.add("error");
                return;
            }

            const dataComp = JSON.parse(textComp); // {id, userId, ...}
            localStorage.setItem("companyId", dataComp.id);
            localStorage.setItem("isCompany", "true");

            msgBox.textContent = "Åžirket kaydÄ± baÅŸarÄ±lÄ±! Åžirket paneline yÃ¶nlendiriliyorsun.";
            msgBox.classList.add("success");

            setTimeout(() => {
                window.location.href = "company.html";
            }, 1200);

        } catch (err) {
            console.error(err);
            msgBox.textContent = "Sunucu hatasÄ± veya backend kapalÄ± olabilir.";
            msgBox.classList.add("error");
        }
    });
</script>

</body>
</html>
