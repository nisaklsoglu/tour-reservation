<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Geli≈ümi≈ü Paket ve Otel Y√∂netimi</title>
    <style>
        /* Stil Dosyalarƒ± (√ñncekilerle Aynƒ± + Yeni Eklemeler) */
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; padding: 20px; }
        .panel { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h2 { margin-top: 0; color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        label { display: block; margin-top: 10px; font-weight: bold; color: #555; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin-top: 5px; }
        
        .btn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; }
        .btn-primary { background: #007bff; }
        .btn-success { background: #28a745; }
        .btn-secondary { background: #6c757d; }

        /* Otel B√∂l√ºm√º */
        .hotel-section { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-top: 20px; border: 1px solid #90caf9; }
        .hotel-list-item { background: white; padding: 8px; margin-top: 5px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        
        /* Yeni Otel Modal */
        #newHotelModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 10px; width: 400px; }

        .modal { 
            display: none; /* Ba≈ülangƒ±√ßta gizli */
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); /* Arka planƒ± karart */
            justify-content: center; 
            align-items: center; 
            z-index: 1000;
        }
        .modal-content { 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            width: 400px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .close-btn { cursor: pointer; font-size: 20px; font-weight: bold; color: #aaa; }
        .close-btn:hover { color: #000; }
    </style>
</head>
<body>

<button class="btn btn-secondary" onclick="location.href='company.html'">‚¨Ö Geri D√∂n</button>

<div class="panel">
    <h2 id="tourTitle">Tur Bilgisi Y√ºkleniyor...</h2>
    <p id="tourDesc">...</p>
</div>

<div class="panel">
    <h2>üìã Mevcut Paketler</h2>
    <table style="width:100%; text-align:left; border-collapse:collapse;">
        <thead>
            <tr style="background:#eee;"><th>Tarih</th><th>Fiyat</th><th>Stok</th><th>ƒ∞≈ülem</th></tr>
        </thead>
        <tbody id="packagesTable">
            <tr><td colspan="4">Y√ºkleniyor...</td></tr>
        </tbody>
    </table>
</div>

<div class="panel">
    <h2>‚ûï Yeni Paket Olu≈ütur</h2>
    <div style="display:flex; gap:10px;">
        <div style="flex:1"><label>Ba≈ülangƒ±√ß:</label><input type="date" id="startDate"></div>
        <div style="flex:1"><label>Biti≈ü:</label><input type="date" id="endDate"></div>
    </div>
    <div style="display:flex; gap:10px;">
        <div style="flex:1"><label>Fiyat (TL):</label><input type="number" id="basePrice"></div>
    </div>
    

    <div class="section-box" style="background:#e3f2fd;">
        <h3>üè® Konaklama Ekle</h3>
        <div style="display:flex; gap:5px; align-items:end;">
            <div style="flex:3;">
                <label>Mevcut Oteller:</label>
                
                <select id="hotelSelect"><option>Y√ºkleniyor...</option></select>
            </div>
            <button class="btn btn-secondary" onclick="openModal('hotelModal')">‚ûï Yeni Ekle</button>
        </div>
        <div style="display:flex; gap:5px;">
            <div style="flex:1"><label>Giri≈ü:</label><input type="date" id="hotelIn"></div>
            <div style="flex:1"><label>√áƒ±kƒ±≈ü:</label><input type="date" id="hotelOut"></div>
            <button class="btn btn-primary" style="margin-top:28px;" onclick="addHotelToList()">Listeye Ekle</button>
        </div>
        <div id="selectedHotelsList"></div>
    </div>

    <div class="section-box" style="background:#fff3cd;">
        <h3>‚úàÔ∏è U√ßu≈ü Ekle</h3>
        <div style="display:flex; gap:5px; align-items:end;">
            <div style="flex:3;">
                <label>Mevcut U√ßu≈ülar:</label>
                <select id="flightSelect"><option>Y√ºkleniyor...</option></select>
            </div>
            <button class="btn btn-secondary" onclick="openModal('flightModal')">‚ûï Yeni Ekle</button>
        </div>
        <div style="display:flex; gap:5px;">
            <div style="flex:1"><label>Tip:</label><select id="flightType"><option>Gidi≈ü</option><option>D√∂n√º≈ü</option><option>Ara U√ßu≈ü</option></select></div>
            <div style="flex:1"><label>Tarih:</label><input type="date" id="flightDate"></div>
        </div>
        <div style="display:flex; gap:5px;">
            <div style="flex:1"><label>Kalkƒ±≈ü:</label><input type="time" id="depTime"></div>
            <div style="flex:1"><label>Varƒ±≈ü:</label><input type="time" id="arrTime"></div>
            <div style="flex:1"><label>S√ºre (Dk):</label><input type="number" id="flightDur" placeholder="120"></div>
            <button class="btn btn-primary" style="margin-top:28px;" onclick="addFlightToList()">Listeye Ekle</button>
        </div>
        <div id="selectedFlightsList"></div>
    </div>

    <div class="section-box" style="background:#d4edda; border-color:#c3e6cb; margin-top:15px;">
        <h3>üß¢ Tur Rehberi Se√ß</h3>
        <div style="display:flex; gap:5px; align-items:end;">
            <div style="flex:3;">
                <label>Mevcut Rehberler:</label>
                <select id="guideSelectBox"><option>Y√ºkleniyor...</option></select>
            </div>
            <button class="btn btn-secondary" onclick="openModal('guideModal')">‚ûï Yeni Rehber</button>
        </div>
        <div style="margin-top:10px; color:#155724; font-size:14px;">
            * Bu paket i√ßin se√ßilen rehber: <strong id="selectedGuideName">Hen√ºz Se√ßilmedi</strong>
        </div>
    </div>

    <button class="btn btn-success" style="width:100%; margin-top:20px; padding:15px;" onclick="saveEverything()">‚úÖ HEPSƒ∞Nƒ∞ KAYDET</button>
</div>

<div id="hotelModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üè® Yeni Otel Tanƒ±mla</h3>
            <span class="close-btn" onclick="closeModal('hotelModal')">√ó</span>
        </div>
        <label>Otel Adƒ±:</label><input type="text" id="newHName">
        <label>Yƒ±ldƒ±z (1-5):</label><input type="number" id="newHRate" min="1" max="5">
        <label>Adres/≈ûehir:</label><input type="text" id="newHAddr">
        <button class="btn btn-success" onclick="saveNewHotel()" style="margin-top:15px; width:100%;">Kaydet</button>
    </div>
</div>

<div id="flightModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>‚úàÔ∏è Yeni U√ßu≈ü Tanƒ±mla</h3>
            <span class="close-btn" onclick="closeModal('flightModal')">√ó</span>
        </div>
        <label>Firma:</label><input type="text" id="newFFirm" placeholder="√ñrn: THY">
        <label>PNR:</label><input type="text" id="newFPnr" placeholder="√ñrn: TK1933">
        <div style="display:flex; gap:10px;">
            <div style="flex:1"><label>Kalkƒ±≈ü:</label><input type="text" id="newFDep" placeholder="IST"></div>
            <div style="flex:1"><label>Varƒ±≈ü:</label><input type="text" id="newFArr" placeholder="CDG"></div>
        </div>
        <button class="btn btn-success" onclick="saveNewFlight()" style="margin-top:15px; width:100%;">Kaydet</button>
    </div>
</div>
<div id="guideModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üß¢ Yeni Rehber Tanƒ±mla</h3>
            <span class="close-btn" onclick="closeModal('guideModal')">√ó</span>
        </div>
        <label>Ad Soyad:</label><input type="text" id="newGName" >
        <label>Telefon:</label><input type="text" id="newGPhone" placeholder="5xx xxx xx xx">
        <label>E-posta:</label><input type="email" id="newGEmail" placeholder="ornek@sirket.com">
        <button class="btn btn-success" onclick="saveNewGuide()" style="margin-top:15px; width:100%;">Kaydet</button>
    </div>
</div>



<script>
    const API_BASE = "http://localhost:8080/api";
    const urlParams = new URLSearchParams(window.location.search);
    const tourId = urlParams.get("tourId");
    let selectedHotels = []; 

    document.addEventListener("DOMContentLoaded", () => {
        if(!tourId) { alert("Tur ID yok!"); return; }
        
        loadTourInfo(); // Bu fonksiyon artƒ±k otelleri de tetikleyecek
        loadPackages();
        loadFlights();
        loadGuides();


        // --- 1. PNR KONTROL√ú (Anlƒ±k) ---
    const pnrInput = document.getElementById("newFPnr");
    if(pnrInput) { // Eƒüer sayfada bu input varsa √ßalƒ±≈üsƒ±n
        pnrInput.addEventListener("input", function() {
            // 1. Otomatik B√ºy√ºt
            this.value = this.value.toUpperCase();
            
            // 2. Regex Kontrol√º (6 Hane, Harf/Rakam)
            const regex = /^[A-Z0-9]{6}$/;
            
            if (regex.test(this.value)) {
                // Doƒüruysa YE≈ûƒ∞L ve kalƒ±n kenar
                this.style.border = "2px solid #28a745"; 
                this.style.backgroundColor = "#e8f5e9";
            } else {
                // Yanlƒ±≈üsa KIRMIZI
                this.style.border = "2px solid #dc3545";
                this.style.backgroundColor = "#f8d7da";
            }
            
            // Bo≈üsa rengi sƒ±fƒ±rla (Griye d√∂n)
            if(this.value === "") {
                this.style.border = "1px solid #ccc";
                this.style.backgroundColor = "white";
            }
        });
    }

    // --- 2. TELEFON KONTROL√ú (Anlƒ±k) ---
    const phoneInput = document.getElementById("newGPhone");
    if(phoneInput) {
        phoneInput.addEventListener("input", function() {
            // Sadece sayƒ± girmesine izin ver (Harfleri sil)
            this.value = this.value.replace(/[^0-9]/g, '');

            // Regex: 05 ile ba≈ülayan, toplam 11 hane
            const regex = /^5[0-9]{9}$/

            if (regex.test(this.value)) {
                this.style.border = "2px solid #28a745";
                this.style.backgroundColor = "#e8f5e9";
            } else {
                this.style.border = "2px solid #dc3545";
                this.style.backgroundColor = "#f8d7da";
            }

            if(this.value === "") {
                this.style.border = "1px solid #ccc";
                this.style.backgroundColor = "white";
            }
        });
    }

    // --- 3. EMAIL KONTROL√ú (Anlƒ±k) ---
    const emailInput = document.getElementById("newGEmail");
    if(emailInput) {
        emailInput.addEventListener("input", function() {
            // Standart Email Regex'i
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (regex.test(this.value)) {
                this.style.border = "2px solid #28a745";
                this.style.backgroundColor = "#e8f5e9";
            } else {
                this.style.border = "2px solid #dc3545";
                this.style.backgroundColor = "#f8d7da";
            }

            if(this.value === "") {
                this.style.border = "1px solid #ccc";
                this.style.backgroundColor = "white";
            }
        });
    }
    });

    let currentTourCapacity = 0;
    // --- 1. TUR Bƒ∞LGƒ∞Sƒ∞Nƒ∞ √áEK VE OTELLERƒ∞ Fƒ∞LTRELE ---
   async function loadTourInfo() {
        try {
            const res = await fetch(`${API_BASE}/tours/${tourId}`);
            if (!res.ok) throw new Error("Tur bulunamadƒ±");
            const data = await res.json();
            
            document.getElementById("tourTitle").innerText = "Tur: " + data.packageName;
            document.getElementById("tourDesc").innerText = data.description;


            const cityNames = data.destinations.map(d => d.destinationCity);
            if(data.capaticy){
                currentTourCapacity = data.capaticy;
                const capInput=data.capaticy
                if(capInput){
                    capInput.value=data.capaticy
                }
            }
                
                console.log("Aranacak ≈ûehirler:", cityNames); 
            // --- √áOKLU ≈ûEHƒ∞R MANTIƒûI ---
            if (cityNames.length > 1) {
            // Bƒ∞RDEN FAZLA ≈ûEHƒ∞R VARSA -> Multi Fonksiyonu
            loadHotelsMulti(cityNames);
        } else if (cityNames.length === 1) {
            // TEK ≈ûEHƒ∞R VARSA -> Tekil Fonksiyon (≈ûehir ismini g√∂nderiyoruz)
            loadHotels(cityNames[0]);
        } else {
            // Hƒ∞√á ≈ûEHƒ∞R YOKSA -> T√ºm otelleri getir (Null g√∂nderiyoruz)
            loadHotels(null);
        }
            
        } catch (err) {
            console.error(err);
            alert("Tur bilgisi √ßekilemedi.");
        }
    }

    // --- REHBER ƒ∞≈ûLEMLERƒ∞ ---
    
    // 1. Rehberleri Getir
    async function loadGuides() {
        const res = await fetch(`${API_BASE}/guides/all`);
        const guides = await res.json();
        
        const select = document.getElementById("guideSelectBox");
        select.innerHTML = '<option value="">Rehber Se√ßiniz...</option>';
        
        guides.forEach(g => {
            const opt = document.createElement("option");
            opt.value = g.guideId;
            opt.text = `${g.guideName} (${g.guidePhone})`;
            select.appendChild(opt);
        });

        // Se√ßim deƒüi≈üince yazƒ±yƒ± g√ºncelle
        select.onchange = function() {
            const name = this.options[this.selectedIndex].text;
            document.getElementById("selectedGuideName").innerText = name !== "Rehber Se√ßiniz..." ? name : "Hen√ºz Se√ßilmedi";
        };
    }

    // 2. Yeni Rehber Kaydet
    async function saveNewGuide() {
        const name = document.getElementById("newGName").value;
        const phone = document.getElementById("newGPhone").value;
        const email = document.getElementById("newGEmail").value;

        if(!name || !email) { alert("Ad ve E-posta zorunlu!"); return; }

        const data = {
            guideName: name,
            guidePhone: phone,
            guideEmail: email
        };

        try {
            const res = await fetch(`${API_BASE}/guides/create`, {
                method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(data)
            });

            if(res.ok) {
                alert("‚úÖ Rehber Eklendi!");
                closeModal('guideModal');
                loadGuides(); // Listeyi yenile
                
                // Formu temizle
                document.getElementById("newGName").value = "";
                document.getElementById("newGPhone").value = "";
                document.getElementById("newGEmail").value = "";
            } else {
                alert("Hata olu≈ütu!");
            }
        } catch(e) { console.error(e); }
    }
   
async function loadHotels(cityName) {
    const select = document.getElementById("hotelSelect");
    select.innerHTML = '<option value="">Y√ºkleniyor...</option>';

    
    select.setAttribute("data-current-city", cityName || "");

    let url;
    if (cityName) {
        // ≈ûehir belli ise o ≈üehirdeki otelleri ara
        url = `${API_BASE}/hotels/search/${cityName}`;
    } else {
        // ≈ûehir yoksa (null) t√ºm otelleri getir
        url = `${API_BASE}/hotels/all`;
    }

    try {
        const res = await fetch(url);
        
        // Eƒüer 404 vs gelirse bo≈ü dizi kabul et
        if(!res.ok) throw new Error("Otel listesi alƒ±namadƒ±");
        
        const hotels = await res.json();

        select.innerHTML = '<option value="">Se√ßiniz...</option>';

        if (hotels.length === 0) {
            const msg = cityName ? `"${cityName}" konumunda` : "Sistemde";
            const opt = document.createElement("option");
            opt.text = `‚ö†Ô∏è ${msg} kayƒ±tlƒ± otel yok.`;
            select.appendChild(opt);
        } else {
            hotels.forEach(h => {
                const opt = document.createElement("option");
                opt.value = h.hotelId;
                
                opt.text = `${h.hotelName} (${h.hotelRate}‚òÖ) - ${h.hotelAddress}`;
                select.appendChild(opt);
            });
        }

    } catch (err) {
        console.error("Tekil otel y√ºkleme hatasƒ±:", err);
        select.innerHTML = '<option value="">Listeleme hatasƒ±</option>';
    }
}

    // --- 2. √áOKLU ≈ûEHƒ∞R ƒ∞√áƒ∞N OTEL GETƒ∞RME ---
    async function loadHotelsMulti(cities) {
        const select = document.getElementById("hotelSelect");
        select.innerHTML = '<option value="">Y√ºkleniyor...</option>';
        
        let allHotels = [];

        try {
            if (!cities || cities.length === 0) {
                // ≈ûehir yoksa t√ºm otelleri getir (Varsayƒ±lan)
                const res = await fetch(`${API_BASE}/hotels/all`);
                allHotels = await res.json();
            } else {
                // Her ≈üehir i√ßin ayrƒ± istek atƒ±p sonu√ßlarƒ± topluyoruz (Parallel Fetch)
                const promises = cities.map(city => 
                    fetch(`${API_BASE}/hotels/search/${city}`).then(res => res.json())
                );

                // T√ºm isteklerin bitmesini bekle
                const results = await Promise.all(promises);

                // Gelen listeleri tek bir havuzda birle≈ütir
                results.forEach(list => allHotels.push(...list));
            }

            
            const uniqueHotels = [];
            const map = new Map();
            for (const item of allHotels) {
                if(!map.has(item.hotelId)){
                    map.set(item.hotelId, true);    // ID'yi kaydet
                    uniqueHotels.push(item);
                }
            }

            // --- KUTUYU DOLDUR ---
            select.innerHTML = '<option value="">Se√ßiniz...</option>';
            
            if (uniqueHotels.length === 0) {
                const opt = document.createElement("option");
                const locMsg = cities ? cities.join(", ") : "Kayƒ±tlƒ±";
                opt.text = `‚ö†Ô∏è "${locMsg}" konumlarƒ±nda otel bulunamadƒ±. Yeni ekleyin ->`;
                select.appendChild(opt);
            } else {
                uniqueHotels.forEach(h => {
                    const opt = document.createElement("option");
                    opt.value = h.hotelId;
                    opt.text = `${h.hotelName} (${h.hotelRate}‚òÖ) - ${h.hotelAddress}`;
                    select.appendChild(opt);
                });
            }

        } catch (err) {
            console.error("Otel y√ºkleme hatasƒ±:", err);
            select.innerHTML = '<option value="">Hata olu≈ütu</option>';
        }
    }

    // --- 3. YENƒ∞ OTEL KAYDET ---
    function openNewHotelModal() {
        document.getElementById("newHotelModal").style.display = "flex";
    }

    // --- 2. Yeni Otel Kaydet (D√úZELTƒ∞LMƒ∞≈û) ---
    async function saveNewHotel() {
        // 1. Deƒüerleri Al
        const hotel_name = document.getElementById("newHName").value; // ID'lere Dikkat!
        const hotel_rate = document.getElementById("newHRate").value;
        const hotel_address = document.getElementById("newHAddr").value;

        // 2. Kontrol Et
        if(!hotel_name || !hotel_rate || !hotel_address) { 
            alert("L√ºtfen t√ºm alanlarƒ± doldurunuz!"); 
            return; 
        }

        // 3. Veriyi Hazƒ±rla (Backend DTO ile uyumlu olmalƒ±)
    
        const data = {
            hotelName: hotel_name,
            hotelRate: parseInt(hotel_rate),
            hotelAddress: hotel_address
        };
        
        console.log("G√∂nderilen Otel Verisi:", data); // Konsoldan kontrol et

        try {
            // 4. ƒ∞steƒüi G√∂nder
            const res = await fetch(`${API_BASE}/hotels/create`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            // 5. Sonucu ƒ∞≈üle
            if(res.ok) {
                alert("‚úÖ Otel Ba≈üarƒ±yla Eklendi!");
                closeModal('hotelModal'); // Pencereyi kapat
                
                // Formu Temizle
                document.getElementById("newHName").value = "";
                document.getElementById("newHRate").value = "";
                document.getElementById("newHAddr").value = "";

        
                const currentCity = document.getElementById("hotelSelect").getAttribute("data-current-city");
                loadHotels(currentCity || null); 

            } else {
                const errorText = await res.text();
                alert("Hata: " + errorText);
            }
        } catch (err) {
            console.error(err);
            alert("Sunucuya baƒülanƒ±lamadƒ±!");
        }
    }

    // --- 4. Lƒ∞STEYE OTEL EKLE (GE√áƒ∞Cƒ∞) ---
    function addHotelToList() {
        const select = document.getElementById("hotelSelect");
        const hotelId = select.value;
        
        if(!hotelId || hotelId === "") { 
            alert("L√ºtfen otel se√ßin!"); 
            return; 
        }

        const hotelName = select.options[select.selectedIndex].text;
        const entry = document.getElementById("hotelIn").value;
        const exit = document.getElementById("hotelOut").value;

        if(!entry || !exit) { alert("Giri≈ü-√áƒ±kƒ±≈ü tarihlerini se√ßin!"); return; }

        selectedHotels.push({ hotelId, entryDate: entry, exitDate: exit, name: hotelName });
        renderSelectedHotels();
    }

    function renderSelectedHotels() {
        const div = document.getElementById("selectedHotelsList");
        div.innerHTML = "";
        selectedHotels.forEach((item, index) => {
            div.innerHTML += `
                <div class="hotel-list-item">
                    <span>üè® ${item.name} (${item.entryDate} - ${item.exitDate})</span>
                    <button onclick="selectedHotels.splice(${index},1); renderSelectedHotels();" style="color:red; border:none; background:none; cursor:pointer;">Sil ‚úï</button>
                </div>`;
        });
    }

    // --- 5. PAKETƒ∞ VE OTELLERƒ∞ KAYDET ---
    async function saveEverything() {

        const guideSelect = document.getElementById("guideSelectBox");
        const pkgData = {
            tourId: parseInt(tourId),
            startDate: document.getElementById("startDate").value,
            endDate: document.getElementById("endDate").value,
            basePrice: document.getElementById("basePrice").value,
            availableSeats:currentTourCapacity, // Sabit stok

            guideId: parseInt(document.getElementById("guideSelectBox").value)
        };

        try {
            // A. Paketi Kaydet
            const pkgRes = await fetch(`${API_BASE}/tours/${tourId}/add-package`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(pkgData)
            });

            if(!pkgRes.ok) throw new Error("Paket kaydedilemedi!");
            const savedPackage = await pkgRes.json();
            const newPackageId = savedPackage.packageId;

            // B. Otelleri Baƒüla
            for (const hotelItem of selectedHotels) {
                const hotelData = {
                    packageId: newPackageId,
                    hotelId: parseInt(hotelItem.hotelId),
                    entryDate: hotelItem.entryDate,
                    exitDate: hotelItem.exitDate
                };

                await fetch(`${API_BASE}/tour-packages/add-hotel`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(hotelData)
                });
            }
            for (const f of selectedFlights) {
                const flightData = {
                    packageId: newPackageId,
                    flightId: parseInt(f.flightId),
                    flightType: f.type,
                    departureDate: f.date,
                    departureTime: f.depTime + ":00", // Saniye formatƒ± i√ßin
                    arrivalTime: f.arrTime + ":00",
                    duration: parseInt(f.duration)
                };

                await fetch(`${API_BASE}/tour-packages/add-flight`, {
                    method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(flightData)
                });
            }

            alert("‚úÖ Paket ve Oteller Ba≈üarƒ±yla Kaydedildi!");
            location.reload();

        } catch (err) {
            alert("Hata: " + err.message);
        }
    }
    
    // --- Paketleri Listele ---
    async function loadPackages() {
        const res = await fetch(`${API_BASE}/tour-packages/by-tour/${tourId}`);
        const data = await res.json();
        const tbody = document.getElementById("packagesTable");
        tbody.innerHTML = "";
        data.forEach(p => {
            tbody.innerHTML += `<tr>
                <td>${p.startDate} - ${p.endDate}</td>
                <td>${p.basePrice} TL</td>
                <td>${p.availableSeats}</td>
               
            </tr>`;
        });
    }


    // --- GLOBAL DEƒûƒ∞≈ûKEN ---
    let selectedFlights = []; 

   
    // --- 1. U√ßu≈ülarƒ± Getir ve Doldur ---
    async function loadFlights() {
        const res = await fetch(`${API_BASE}/flights/all`);
        const flights = await res.json();
        
        const select = document.getElementById("flightSelect");
        select.innerHTML = '<option value="">Se√ßiniz...</option>';
        flights.forEach(f => {
            const opt = document.createElement("option");
            opt.value = f.flightId;
            opt.text = `${f.firma} (${f.pnrNo}) | ${f.kalkisKonumu} ‚ûù ${f.varisKonumu}`;
            select.appendChild(opt);
        });
    }

    // --- 2. Yeni U√ßu≈ü Kaydet (Modal) ---
    // --- YENƒ∞ U√áU≈ûU VERƒ∞TABANINA KAYDET ---
    async function saveNewFlight() {
        const firm = document.getElementById("newFFirm").value;
        let pnr = document.getElementById("newFPnr").value.trim().toUpperCase();
        const dep = document.getElementById("newFDep").value;
        const arr = document.getElementById("newFArr").value;
        const pnrRegex = /^[A-Z0-9]{6}$/;

        if (!pnrRegex.test(pnr)) {
        alert("‚õî HATA: PNR kodu tam 6 haneli olmalƒ± ve sadece harf/rakam i√ßermelidir! (√ñrn: TK1933 deƒüil, 1A2B3C formatƒ±nda)");
        return; // ƒ∞≈ülemi durdur
    }
        if(!firm || !pnr || !dep || !arr) {
            alert("L√ºtfen t√ºm alanlarƒ± doldurun!");
            return;
        }

        // Backend'deki Flight nesnesine uygun JSON
        const data = {
            firma: firm,
            pnrNo: pnr,
            kalkisKonumu: dep,
            varisKonumu: arr
        };

        try {
            const res = await fetch(`${API_BASE}/flights/create`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            if(res.ok) {
                alert("‚úÖ U√ßu≈ü ba≈üarƒ±yla tanƒ±mlandƒ±!");
                closeModal('flightModal'); // Modalƒ± kapat
                
                // Formu temizle
                document.getElementById("newFFirm").value = "";
                document.getElementById("newFPnr").value = "";
                document.getElementById("newFDep").value = "";
                document.getElementById("newFArr").value = "";

                loadFlights(); // Lƒ∞STEYƒ∞ YENƒ∞LE (En √∂nemli kƒ±sƒ±m)
            } else {
                alert("Hata: U√ßu≈ü kaydedilemedi.");
            }
        } catch (err) {
            console.error(err);
            alert("Sunucu hatasƒ±!");
        }
    }

    // --- 3. Listeye U√ßu≈ü Ekle (Ge√ßici Hafƒ±za) ---
    function addFlightToList() {
        const select = document.getElementById("flightSelect");
        const flightId = select.value;
        if(!flightId) return alert("U√ßu≈ü se√ßin!");

        const flightName = select.options[select.selectedIndex].text;
        
        const item = {
            flightId: flightId,
            name: flightName,
            type: document.getElementById("flightType").value,
            date: document.getElementById("flightDate").value,
            depTime: document.getElementById("depTime").value,
            arrTime: document.getElementById("arrTime").value,
            duration: document.getElementById("flightDur").value
        };

        if(!item.date || !item.depTime) return alert("Tarih ve Saat zorunlu!");

        selectedFlights.push(item);
        renderSelectedFlights();
    }

    function renderSelectedFlights() {
        const div = document.getElementById("selectedFlightsList");
        div.innerHTML = "";
        selectedFlights.forEach((item, index) => {
            div.innerHTML += `
                <div class="hotel-list-item">
                    <span>‚úàÔ∏è ${item.type}: ${item.name} <br> <small>${item.date} | ${item.depTime} - ${item.arrTime}</small></span>
                    <button onclick="selectedFlights.splice(${index},1); renderSelectedFlights();" style="color:red; border:none; cursor:pointer;">Sil</button>
                </div>`;
        });
    }
    // savePackageWithHotels fonksiyonunun adƒ±nƒ± 'saveEverything' yapabilirsin
    // ƒ∞√ßine ≈üu d√∂ng√ºy√º ekle:

    /*
            // C. U√ßu≈ülarƒ± Baƒüla
            for (const f of selectedFlights) {
                const flightData = {
                    packageId: newPackageId,
                    flightId: parseInt(f.flightId),
                    flightType: f.type,
                    departureDate: f.date,
                    departureTime: f.depTime + ":00", // Saniye formatƒ± i√ßin
                    arrivalTime: f.arrTime + ":00",
                    duration: parseInt(f.duration)
                };

                await fetch(`${API_BASE}/tour-packages/add-flight`, {
                    method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(flightData)
                });
            }
    */

   // --- MODAL (PENCERE) A√áMA KAPAMA YARDIMCILARI ---
    function openModal(id) {
        document.getElementById(id).style.display = "flex";
    }

    function closeModal(id) {
        document.getElementById(id).style.display = "none";
    }
</script>


</body>
</html>