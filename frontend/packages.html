<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>GeliÅŸmiÅŸ Paket ve Otel YÃ¶netimi</title>
    <style>
        /* Stil DosyalarÄ± (Ã–ncekilerle AynÄ± + Yeni Eklemeler) */
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; padding: 20px; }
        .panel { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h2 { margin-top: 0; color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        label { display: block; margin-top: 10px; font-weight: bold; color: #555; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin-top: 5px; }
        
        .btn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; }
        .btn-primary { background: #007bff; }
        .btn-success { background: #28a745; }
        .btn-secondary { background: #6c757d; }

        /* Otel BÃ¶lÃ¼mÃ¼ */
        .hotel-section { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-top: 20px; border: 1px solid #90caf9; }
        .hotel-list-item { background: white; padding: 8px; margin-top: 5px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        
        /* Yeni Otel Modal */
        #newHotelModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 10px; width: 400px; }

        .modal { 
            display: none; /* BaÅŸlangÄ±Ã§ta gizli */
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); /* Arka planÄ± karart */
            justify-content: center; 
            align-items: center; 
            z-index: 1000;
        }
        .modal-content { 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            width: 400px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .close-btn { cursor: pointer; font-size: 20px; font-weight: bold; color: #aaa; }
        .close-btn:hover { color: #000; }
    </style>
</head>
<body>

<button class="btn btn-secondary" onclick="location.href='company.html'">â¬… Geri DÃ¶n</button>

<div class="panel">
    <h2 id="tourTitle">Tur Bilgisi YÃ¼kleniyor...</h2>
    <p id="tourDesc">...</p>
</div>

<div class="panel">
    <h2>ğŸ“‹ Mevcut Paketler</h2>
    <table style="width:100%; text-align:left; border-collapse:collapse;">
        <thead>
            <tr style="background:#eee;"><th>Tarih</th><th>Fiyat</th><th>Stok</th><th>Ä°ÅŸlem</th></tr>
        </thead>
        <tbody id="packagesTable">
            <tr><td colspan="4">YÃ¼kleniyor...</td></tr>
        </tbody>
    </table>
</div>

<div class="panel">
    <h2>â• Yeni Paket OluÅŸtur</h2>
    <div style="display:flex; gap:10px;">
        <div style="flex:1"><label>BaÅŸlangÄ±Ã§:</label><input type="date" id="startDate"></div>
        <div style="flex:1"><label>BitiÅŸ:</label><input type="date" id="endDate"></div>
    </div>
    <div style="display:flex; gap:10px;">
        <div style="flex:1"><label>Fiyat (TL):</label><input type="number" id="basePrice"></div>
    </div>
    

    <div class="section-box" style="background:#e3f2fd;">
        <h3>ğŸ¨ Konaklama Ekle</h3>
        <div style="display:flex; gap:5px; align-items:end;">
            <div style="flex:3;">
                <label>Mevcut Oteller:</label>
                
                <select id="hotelSelect"><option>YÃ¼kleniyor...</option></select>
            </div>
            <button class="btn btn-secondary" onclick="openModal('hotelModal')">â• Yeni Ekle</button>
        </div>
        <div style="display:flex; gap:5px;">
            <div style="flex:1"><label>GiriÅŸ:</label><input type="date" id="hotelIn"></div>
            <div style="flex:1"><label>Ã‡Ä±kÄ±ÅŸ:</label><input type="date" id="hotelOut"></div>
            <button class="btn btn-primary" style="margin-top:28px;" onclick="addHotelToList()">Listeye Ekle</button>
        </div>
        <div id="selectedHotelsList"></div>
    </div>

    <div class="section-box" style="background:#fff3cd;">
        <h3>âœˆï¸ UÃ§uÅŸ Ekle</h3>
        <div style="display:flex; gap:5px; align-items:end;">
            <div style="flex:3;">
                <label>Mevcut UÃ§uÅŸlar:</label>
                <select id="flightSelect"><option>YÃ¼kleniyor...</option></select>
            </div>
            <button class="btn btn-secondary" onclick="openModal('flightModal')">â• Yeni Ekle</button>
        </div>
        <div style="display:flex; gap:5px;">
            <div style="flex:1"><label>Tip:</label><select id="flightType"><option>GidiÅŸ</option><option>DÃ¶nÃ¼ÅŸ</option><option>Ara UÃ§uÅŸ</option></select></div>
            <div style="flex:1"><label>Tarih:</label><input type="date" id="flightDate"></div>
        </div>
        <div style="display:flex; gap:5px;">
            <div style="flex:1"><label>KalkÄ±ÅŸ:</label><input type="time" id="depTime"></div>
            <div style="flex:1"><label>VarÄ±ÅŸ:</label><input type="time" id="arrTime"></div>
            <div style="flex:1"><label>SÃ¼re (Dk):</label><input type="number" id="flightDur" placeholder="120"></div>
            <button class="btn btn-primary" style="margin-top:28px;" onclick="addFlightToList()">Listeye Ekle</button>
        </div>
        <div id="selectedFlightsList"></div>
    </div>

    <div class="section-box" style="background:#d4edda; border-color:#c3e6cb; margin-top:15px;">
        <h3>ğŸ§¢ Tur Rehberi SeÃ§</h3>
        <div style="display:flex; gap:5px; align-items:end;">
            <div style="flex:3;">
                <label>Mevcut Rehberler:</label>
                <select id="guideSelectBox"><option>YÃ¼kleniyor...</option></select>
            </div>
            <button class="btn btn-secondary" onclick="openModal('guideModal')">â• Yeni Rehber</button>
        </div>
        <div style="margin-top:10px; color:#155724; font-size:14px;">
            * Bu paket iÃ§in seÃ§ilen rehber: <strong id="selectedGuideName">HenÃ¼z SeÃ§ilmedi</strong>
        </div>
    </div>

    <button class="btn btn-success" style="width:100%; margin-top:20px; padding:15px;" onclick="saveEverything()">âœ… HEPSÄ°NÄ° KAYDET</button>
</div>

<div id="hotelModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ¨ Yeni Otel TanÄ±mla</h3>
            <span class="close-btn" onclick="closeModal('hotelModal')">Ã—</span>
        </div>
        <label>Otel AdÄ±:</label><input type="text" id="newHName">
        <label>YÄ±ldÄ±z (1-5):</label><input type="number" id="newHRate" min="1" max="5">
        <label>Adres/Åehir:</label><input type="text" id="newHAddr">
        <button class="btn btn-success" onclick="saveNewHotel()" style="margin-top:15px; width:100%;">Kaydet</button>
    </div>
</div>

<div id="flightModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>âœˆï¸ Yeni UÃ§uÅŸ TanÄ±mla</h3>
            <span class="close-btn" onclick="closeModal('flightModal')">Ã—</span>
        </div>
        <label>Firma:</label><input type="text" id="newFFirm" placeholder="Ã–rn: THY">
        <label>PNR:</label><input type="text" id="newFPnr" placeholder="Ã–rn: TK1933">
        <div style="display:flex; gap:10px;">
            <div style="flex:1"><label>KalkÄ±ÅŸ:</label><input type="text" id="newFDep" placeholder="IST"></div>
            <div style="flex:1"><label>VarÄ±ÅŸ:</label><input type="text" id="newFArr" placeholder="CDG"></div>
        </div>
        <button class="btn btn-success" onclick="saveNewFlight()" style="margin-top:15px; width:100%;">Kaydet</button>
    </div>
</div>
<div id="guideModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ§¢ Yeni Rehber TanÄ±mla</h3>
            <span class="close-btn" onclick="closeModal('guideModal')">Ã—</span>
        </div>
        <label>Ad Soyad:</label><input type="text" id="newGName" >
        <label>Telefon:</label><input type="text" id="newGPhone" placeholder="5xx xxx xx xx">
        <label>E-posta:</label><input type="email" id="newGEmail" placeholder="ornek@sirket.com">
        <button class="btn btn-success" onclick="saveNewGuide()" style="margin-top:15px; width:100%;">Kaydet</button>
    </div>
</div>



<script>
    const API_BASE = "http://localhost:8080/api";
    const urlParams = new URLSearchParams(window.location.search);
    const tourId = urlParams.get("tourId");
    let selectedHotels = []; 

    document.addEventListener("DOMContentLoaded", () => {
        if(!tourId) { alert("Tur ID yok!"); return; }
        
        loadTourInfo(); // Bu fonksiyon artÄ±k otelleri de tetikleyecek
        loadPackages();
        loadFlights();
        loadGuides();


        // --- 1. PNR KONTROLÃœ (AnlÄ±k) ---
    const pnrInput = document.getElementById("newFPnr");
    if(pnrInput) { // EÄŸer sayfada bu input varsa Ã§alÄ±ÅŸsÄ±n
        pnrInput.addEventListener("input", function() {
            // 1. Otomatik BÃ¼yÃ¼t
            this.value = this.value.toUpperCase();
            
            // 2. Regex KontrolÃ¼ (6 Hane, Harf/Rakam)
            const regex = /^[A-Z0-9]{6}$/;
            
            if (regex.test(this.value)) {
                // DoÄŸruysa YEÅÄ°L ve kalÄ±n kenar
                this.style.border = "2px solid #28a745"; 
                this.style.backgroundColor = "#e8f5e9";
            } else {
                // YanlÄ±ÅŸsa KIRMIZI
                this.style.border = "2px solid #dc3545";
                this.style.backgroundColor = "#f8d7da";
            }
            
            // BoÅŸsa rengi sÄ±fÄ±rla (Griye dÃ¶n)
            if(this.value === "") {
                this.style.border = "1px solid #ccc";
                this.style.backgroundColor = "white";
            }
        });
    }

    // --- 2. TELEFON KONTROLÃœ (AnlÄ±k) ---
    const phoneInput = document.getElementById("newGPhone");
    if(phoneInput) {
        phoneInput.addEventListener("input", function() {
            // Sadece sayÄ± girmesine izin ver (Harfleri sil)
            this.value = this.value.replace(/[^0-9]/g, '');

            // Regex: 05 ile baÅŸlayan, toplam 11 hane
            const regex = /^5[0-9]{9}$/

            if (regex.test(this.value)) {
                this.style.border = "2px solid #28a745";
                this.style.backgroundColor = "#e8f5e9";
            } else {
                this.style.border = "2px solid #dc3545";
                this.style.backgroundColor = "#f8d7da";
            }

            if(this.value === "") {
                this.style.border = "1px solid #ccc";
                this.style.backgroundColor = "white";
            }
        });
    }

    // --- 3. EMAIL KONTROLÃœ (AnlÄ±k) ---
    const emailInput = document.getElementById("newGEmail");
    if(emailInput) {
        emailInput.addEventListener("input", function() {
            // Standart Email Regex'i
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (regex.test(this.value)) {
                this.style.border = "2px solid #28a745";
                this.style.backgroundColor = "#e8f5e9";
            } else {
                this.style.border = "2px solid #dc3545";
                this.style.backgroundColor = "#f8d7da";
            }

            if(this.value === "") {
                this.style.border = "1px solid #ccc";
                this.style.backgroundColor = "white";
            }
        });
    }
    });

    let currentTourCapacity = 0;
    // --- 1. TUR BÄ°LGÄ°SÄ°NÄ° Ã‡EK VE OTELLERÄ° FÄ°LTRELE ---
    async function loadTourInfo() {
        try {
            const res = await fetch(`${API_BASE}/tours/${tourId}`);
            if (!res.ok) throw new Error("Tur bulunamadÄ±");
            const data = await res.json();
            
            document.getElementById("tourTitle").innerText = "Tur: " + data.packageName;
            document.getElementById("tourDesc").innerText = data.description;
            if(data.capaticy){
                currentTourCapacity = data.capaticy;
                const capInput=data.capaticy
                if(capInput){
                    capInput.value=data.capaticy
                }
            }

             
                
                console.log("Aranacak Åehirler:", cityNames); 
            // --- Ã‡OKLU ÅEHÄ°R MANTIÄI BURADA ---
            if (cityNames.length > 1) {
            // BÄ°RDEN FAZLA ÅEHÄ°R VARSA -> Multi Fonksiyonu
            loadHotelsMulti(cityNames);
        } else if (cityNames.length === 1) {
            // TEK ÅEHÄ°R VARSA -> Tekil Fonksiyon (Åehir ismini gÃ¶nderiyoruz)
            loadHotels(cityNames[0]);
        } else {
            // HÄ°Ã‡ ÅEHÄ°R YOKSA -> TÃ¼m otelleri getir (Null gÃ¶nderiyoruz)
            loadHotels(null);
        }
            
        } catch (err) {
            console.error(err);
            alert("Tur bilgisi Ã§ekilemedi.");
        }
    }

    // --- REHBER Ä°ÅLEMLERÄ° ---
    
    // 1. Rehberleri Getir
    async function loadGuides() {
        const res = await fetch(`${API_BASE}/guides/all`);
        const guides = await res.json();
        
        const select = document.getElementById("guideSelectBox");
        select.innerHTML = '<option value="">Rehber SeÃ§iniz...</option>';
        
        guides.forEach(g => {
            const opt = document.createElement("option");
            opt.value = g.guideId;
            opt.text = `${g.guideName} (${g.guidePhone})`;
            select.appendChild(opt);
        });

        // SeÃ§im deÄŸiÅŸince yazÄ±yÄ± gÃ¼ncelle
        select.onchange = function() {
            const name = this.options[this.selectedIndex].text;
            document.getElementById("selectedGuideName").innerText = name !== "Rehber SeÃ§iniz..." ? name : "HenÃ¼z SeÃ§ilmedi";
        };
    }

    // 2. Yeni Rehber Kaydet
    async function saveNewGuide() {
        const name = document.getElementById("newGName").value;
        const phone = document.getElementById("newGPhone").value;
        const email = document.getElementById("newGEmail").value;

        if(!name || !email) { alert("Ad ve E-posta zorunlu!"); return; }

        const data = {
            guideName: name,
            guidePhone: phone,
            guideEmail: email
        };

        try {
            const res = await fetch(`${API_BASE}/guides/create`, {
                method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(data)
            });

            if(res.ok) {
                alert("âœ… Rehber Eklendi!");
                closeModal('guideModal');
                loadGuides(); // Listeyi yenile
                
                // Formu temizle
                document.getElementById("newGName").value = "";
                document.getElementById("newGPhone").value = "";
                document.getElementById("newGEmail").value = "";
            } else {
                alert("Hata oluÅŸtu!");
            }
        } catch(e) { console.error(e); }
    }
    // --- YENÄ°: TEK ÅEHÄ°R Ä°Ã‡Ä°N OTEL GETÄ°RME ---
async function loadHotels(cityName) {
    const select = document.getElementById("hotelSelect");
    select.innerHTML = '<option value="">YÃ¼kleniyor...</option>';

    // Bu Ã¶zelliÄŸi, yeni otel eklerken hangi ÅŸehri yenileyeceÄŸimizi bilmek iÃ§in ekliyoruz
    select.setAttribute("data-current-city", cityName || "");

    let url;
    if (cityName) {
        // Åehir belli ise o ÅŸehirdeki otelleri ara
        url = `${API_BASE}/hotels/search/${cityName}`;
    } else {
        // Åehir yoksa (null) tÃ¼m otelleri getir
        url = `${API_BASE}/hotels/all`;
    }

    try {
        const res = await fetch(url);
        
        // EÄŸer 404 vs gelirse boÅŸ dizi kabul et
        if(!res.ok) throw new Error("Otel listesi alÄ±namadÄ±");
        
        const hotels = await res.json();

        select.innerHTML = '<option value="">SeÃ§iniz...</option>';

        if (hotels.length === 0) {
            const msg = cityName ? `"${cityName}" konumunda` : "Sistemde";
            const opt = document.createElement("option");
            opt.text = `âš ï¸ ${msg} kayÄ±tlÄ± otel yok.`;
            select.appendChild(opt);
        } else {
            hotels.forEach(h => {
                const opt = document.createElement("option");
                opt.value = h.hotelId;
                // Åehir filtreli olduÄŸu iÃ§in parantez iÃ§inde sadece yÄ±ldÄ±z yazabiliriz
                opt.text = `${h.hotelName} (${h.hotelRate}â˜…) - ${h.hotelAddress}`;
                select.appendChild(opt);
            });
        }

    } catch (err) {
        console.error("Tekil otel yÃ¼kleme hatasÄ±:", err);
        select.innerHTML = '<option value="">Listeleme hatasÄ±</option>';
    }
}

    // --- 2. Ã‡OKLU ÅEHÄ°R Ä°Ã‡Ä°N OTEL GETÄ°RME ---
    async function loadHotelsMulti(cities) {
        const select = document.getElementById("hotelSelect");
        select.innerHTML = '<option value="">YÃ¼kleniyor...</option>';
        
        let allHotels = [];

        try {
            if (!cities || cities.length === 0) {
                // Åehir yoksa tÃ¼m otelleri getir (VarsayÄ±lan)
                const res = await fetch(`${API_BASE}/hotels/all`);
                allHotels = await res.json();
            } else {
                // Her ÅŸehir iÃ§in ayrÄ± istek atÄ±p sonuÃ§larÄ± topluyoruz (Parallel Fetch)
                const promises = cities.map(city => 
                    fetch(`${API_BASE}/hotels/search/${city}`).then(res => res.json())
                );

                // TÃ¼m isteklerin bitmesini bekle
                const results = await Promise.all(promises);

                // Gelen listeleri tek bir havuzda birleÅŸtir
                results.forEach(list => allHotels.push(...list));
            }

            // --- AYNI OTELÄ° Ä°KÄ° KERE EKLEMEYÄ° Ã–NLE (TekilleÅŸtirme) ---
            // (Belki bir otelin adresinde hem Paris hem Fransa geÃ§iyordur, Ã§ift gelmesin)
            const uniqueHotels = [];
            const map = new Map();
            for (const item of allHotels) {
                if(!map.has(item.hotelId)){
                    map.set(item.hotelId, true);    // ID'yi kaydet
                    uniqueHotels.push(item);
                }
            }

            // --- KUTUYU DOLDUR ---
            select.innerHTML = '<option value="">SeÃ§iniz...</option>';
            
            if (uniqueHotels.length === 0) {
                const opt = document.createElement("option");
                const locMsg = cities ? cities.join(", ") : "KayÄ±tlÄ±";
                opt.text = `âš ï¸ "${locMsg}" konumlarÄ±nda otel bulunamadÄ±. Yeni ekleyin ->`;
                select.appendChild(opt);
            } else {
                uniqueHotels.forEach(h => {
                    const opt = document.createElement("option");
                    opt.value = h.hotelId;
                    opt.text = `${h.hotelName} (${h.hotelRate}â˜…) - ${h.hotelAddress}`;
                    select.appendChild(opt);
                });
            }

        } catch (err) {
            console.error("Otel yÃ¼kleme hatasÄ±:", err);
            select.innerHTML = '<option value="">Hata oluÅŸtu</option>';
        }
    }

    // --- 3. YENÄ° OTEL KAYDET ---
    function openNewHotelModal() {
        document.getElementById("newHotelModal").style.display = "flex";
    }

    // --- 2. Yeni Otel Kaydet (DÃœZELTÄ°LMÄ°Å) ---
    async function saveNewHotel() {
        // 1. DeÄŸerleri Al
        const hotel_name = document.getElementById("newHName").value; // ID'lere Dikkat!
        const hotel_rate = document.getElementById("newHRate").value;
        const hotel_address = document.getElementById("newHAddr").value;

        // 2. Kontrol Et
        if(!hotel_name || !hotel_rate || !hotel_address) { 
            alert("LÃ¼tfen tÃ¼m alanlarÄ± doldurunuz!"); 
            return; 
        }

        // 3. Veriyi HazÄ±rla (Backend DTO ile uyumlu olmalÄ±)
        // HotelRequest.java: hotelName, hotelRate, hotelAddress
        const data = {
            hotelName: hotel_name,
            hotelRate: parseInt(hotel_rate),
            hotelAddress: hotel_address
        };
        
        console.log("GÃ¶nderilen Otel Verisi:", data); // Konsoldan kontrol et

        try {
            // 4. Ä°steÄŸi GÃ¶nder
            const res = await fetch(`${API_BASE}/hotels/create`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            // 5. Sonucu Ä°ÅŸle
            if(res.ok) {
                alert("âœ… Otel BaÅŸarÄ±yla Eklendi!");
                closeModal('hotelModal'); // Pencereyi kapat
                
                // Formu Temizle
                document.getElementById("newHName").value = "";
                document.getElementById("newHRate").value = "";
                document.getElementById("newHAddr").value = "";

                // Listeyi Yenile (Yeni otel gÃ¶rÃ¼nsÃ¼n diye)
                // Åehre gÃ¶re filtreleme varsa, mevcut ÅŸehri koruyarak yenilememiz lazÄ±m.
                // Åimdilik basitÃ§e loadHotels() diyoruz, eÄŸer hata verirse loadHotels(null) dene.
                
                // Mevcut Turun Åehrini Bulup Yenileyelim (Daha AkÄ±llÄ±ca)
                const currentCity = document.getElementById("hotelSelect").getAttribute("data-current-city");
                loadHotels(currentCity || null); 

            } else {
                const errorText = await res.text();
                alert("Hata: " + errorText);
            }
        } catch (err) {
            console.error(err);
            alert("Sunucuya baÄŸlanÄ±lamadÄ±!");
        }
    }

    // --- 4. LÄ°STEYE OTEL EKLE (GEÃ‡Ä°CÄ°) ---
    function addHotelToList() {
        const select = document.getElementById("hotelSelect");
        const hotelId = select.value;
        
        if(!hotelId || hotelId === "") { 
            alert("LÃ¼tfen otel seÃ§in!"); 
            return; 
        }

        const hotelName = select.options[select.selectedIndex].text;
        const entry = document.getElementById("hotelIn").value;
        const exit = document.getElementById("hotelOut").value;

        if(!entry || !exit) { alert("GiriÅŸ-Ã‡Ä±kÄ±ÅŸ tarihlerini seÃ§in!"); return; }

        selectedHotels.push({ hotelId, entryDate: entry, exitDate: exit, name: hotelName });
        renderSelectedHotels();
    }

    function renderSelectedHotels() {
        const div = document.getElementById("selectedHotelsList");
        div.innerHTML = "";
        selectedHotels.forEach((item, index) => {
            div.innerHTML += `
                <div class="hotel-list-item">
                    <span>ğŸ¨ ${item.name} (${item.entryDate} - ${item.exitDate})</span>
                    <button onclick="selectedHotels.splice(${index},1); renderSelectedHotels();" style="color:red; border:none; background:none; cursor:pointer;">Sil âœ•</button>
                </div>`;
        });
    }

    // --- 5. PAKETÄ° VE OTELLERÄ° KAYDET ---
    async function saveEverything() {

        const guideSelect = document.getElementById("guideSelectBox");
        const pkgData = {
            tourId: parseInt(tourId),
            startDate: document.getElementById("startDate").value,
            endDate: document.getElementById("endDate").value,
            basePrice: document.getElementById("basePrice").value,
            availableSeats:currentTourCapacity, // Sabit stok

            guideId: parseInt(document.getElementById("guideSelectBox").value)
        };

        try {
            // A. Paketi Kaydet
            const pkgRes = await fetch(`${API_BASE}/tours/${tourId}/add-package`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(pkgData)
            });

            if(!pkgRes.ok) throw new Error("Paket kaydedilemedi!");
            const savedPackage = await pkgRes.json();
            const newPackageId = savedPackage.packageId;

            // B. Otelleri BaÄŸla
            for (const hotelItem of selectedHotels) {
                const hotelData = {
                    packageId: newPackageId,
                    hotelId: parseInt(hotelItem.hotelId),
                    entryDate: hotelItem.entryDate,
                    exitDate: hotelItem.exitDate
                };

                await fetch(`${API_BASE}/tour-packages/add-hotel`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(hotelData)
                });
            }
            for (const f of selectedFlights) {
                const flightData = {
                    packageId: newPackageId,
                    flightId: parseInt(f.flightId),
                    flightType: f.type,
                    departureDate: f.date,
                    departureTime: f.depTime + ":00", // Saniye formatÄ± iÃ§in
                    arrivalTime: f.arrTime + ":00",
                    duration: parseInt(f.duration)
                };

                await fetch(`${API_BASE}/tour-packages/add-flight`, {
                    method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(flightData)
                });
            }

            alert("âœ… Paket ve Oteller BaÅŸarÄ±yla Kaydedildi!");
            location.reload();

        } catch (err) {
            alert("Hata: " + err.message);
        }
    }
    
    // --- Paketleri Listele ---
    async function loadPackages() {
        const res = await fetch(`${API_BASE}/tour-packages/by-tour/${tourId}`);
        const data = await res.json();
        const tbody = document.getElementById("packagesTable");
        tbody.innerHTML = "";
        data.forEach(p => {
            tbody.innerHTML += `<tr>
                <td>${p.startDate} - ${p.endDate}</td>
                <td>${p.basePrice} TL</td>
                <td>${p.availableSeats}</td>
               
            </tr>`;
        });
    }


    // --- GLOBAL DEÄÄ°ÅKEN ---
    let selectedFlights = []; 

    // Sayfa aÃ§Ä±lÄ±ÅŸÄ±nda Ã§alÄ±ÅŸacaklara ekle:
    // loadFlights(); // (DOMContentLoaded iÃ§ine ekle)

    // --- 1. UÃ§uÅŸlarÄ± Getir ve Doldur ---
    async function loadFlights() {
        const res = await fetch(`${API_BASE}/flights/all`);
        const flights = await res.json();
        
        const select = document.getElementById("flightSelect");
        select.innerHTML = '<option value="">SeÃ§iniz...</option>';
        flights.forEach(f => {
            const opt = document.createElement("option");
            opt.value = f.flightId;
            opt.text = `${f.firma} (${f.pnrNo}) | ${f.kalkisKonumu} â ${f.varisKonumu}`;
            select.appendChild(opt);
        });
    }

    // --- 2. Yeni UÃ§uÅŸ Kaydet (Modal) ---
    // --- YENÄ° UÃ‡UÅU VERÄ°TABANINA KAYDET ---
    async function saveNewFlight() {
        const firm = document.getElementById("newFFirm").value;
        let pnr = document.getElementById("newFPnr").value.trim().toUpperCase();
        const dep = document.getElementById("newFDep").value;
        const arr = document.getElementById("newFArr").value;
        const pnrRegex = /^[A-Z0-9]{6}$/;

        if (!pnrRegex.test(pnr)) {
        alert("â›” HATA: PNR kodu tam 6 haneli olmalÄ± ve sadece harf/rakam iÃ§ermelidir! (Ã–rn: TK1933 deÄŸil, 1A2B3C formatÄ±nda)");
        return; // Ä°ÅŸlemi durdur
    }
        if(!firm || !pnr || !dep || !arr) {
            alert("LÃ¼tfen tÃ¼m alanlarÄ± doldurun!");
            return;
        }

        // Backend'deki Flight nesnesine uygun JSON
        const data = {
            firma: firm,
            pnrNo: pnr,
            kalkisKonumu: dep,
            varisKonumu: arr
        };

        try {
            const res = await fetch(`${API_BASE}/flights/create`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            if(res.ok) {
                alert("âœ… UÃ§uÅŸ baÅŸarÄ±yla tanÄ±mlandÄ±!");
                closeModal('flightModal'); // ModalÄ± kapat
                
                // Formu temizle
                document.getElementById("newFFirm").value = "";
                document.getElementById("newFPnr").value = "";
                document.getElementById("newFDep").value = "";
                document.getElementById("newFArr").value = "";

                loadFlights(); // LÄ°STEYÄ° YENÄ°LE (En Ã¶nemli kÄ±sÄ±m)
            } else {
                alert("Hata: UÃ§uÅŸ kaydedilemedi.");
            }
        } catch (err) {
            console.error(err);
            alert("Sunucu hatasÄ±!");
        }
    }

    // --- 3. Listeye UÃ§uÅŸ Ekle (GeÃ§ici HafÄ±za) ---
    function addFlightToList() {
        const select = document.getElementById("flightSelect");
        const flightId = select.value;
        if(!flightId) return alert("UÃ§uÅŸ seÃ§in!");

        const flightName = select.options[select.selectedIndex].text;
        
        const item = {
            flightId: flightId,
            name: flightName,
            type: document.getElementById("flightType").value,
            date: document.getElementById("flightDate").value,
            depTime: document.getElementById("depTime").value,
            arrTime: document.getElementById("arrTime").value,
            duration: document.getElementById("flightDur").value
        };

        if(!item.date || !item.depTime) return alert("Tarih ve Saat zorunlu!");

        selectedFlights.push(item);
        renderSelectedFlights();
    }

    function renderSelectedFlights() {
        const div = document.getElementById("selectedFlightsList");
        div.innerHTML = "";
        selectedFlights.forEach((item, index) => {
            div.innerHTML += `
                <div class="hotel-list-item">
                    <span>âœˆï¸ ${item.type}: ${item.name} <br> <small>${item.date} | ${item.depTime} - ${item.arrTime}</small></span>
                    <button onclick="selectedFlights.splice(${index},1); renderSelectedFlights();" style="color:red; border:none; cursor:pointer;">Sil</button>
                </div>`;
        });
    }

    // --- 4. KAYIT FONKSÄ°YONUNU GÃœNCELLE ---
    // savePackageWithHotels fonksiyonunun adÄ±nÄ± 'saveEverything' yapabilirsin
    // Ä°Ã§ine ÅŸu dÃ¶ngÃ¼yÃ¼ ekle:

    /*
            // C. UÃ§uÅŸlarÄ± BaÄŸla
            for (const f of selectedFlights) {
                const flightData = {
                    packageId: newPackageId,
                    flightId: parseInt(f.flightId),
                    flightType: f.type,
                    departureDate: f.date,
                    departureTime: f.depTime + ":00", // Saniye formatÄ± iÃ§in
                    arrivalTime: f.arrTime + ":00",
                    duration: parseInt(f.duration)
                };

                await fetch(`${API_BASE}/tour-packages/add-flight`, {
                    method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(flightData)
                });
            }
    */

   // --- MODAL (PENCERE) AÃ‡MA KAPAMA YARDIMCILARI ---
    function openModal(id) {
        document.getElementById(id).style.display = "flex";
    }

    function closeModal(id) {
        document.getElementById(id).style.display = "none";
    }
</script>


</body>
</html>